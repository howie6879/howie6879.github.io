<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta name="generator" content="Hugo 0.110.0">
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="数据库使用 # 介绍中说的很明白，Sanic 是一个可以使用 async/await 语法编写项目的异步非阻塞框架，既然是异步框架，那么在使用过程中用到的第三方包也最好是异步的，比如http请求，最好就使用aihttp而非requests，对于数据库的连接，也是同样如此，下面我将用代码的形式来说明下如何在Sanic中连接数据库。
操作Mysql # 对于mysql数据库的异步操作，我只在一些脚本中用过，用的是aiomysql，其中官方文档中讲得很清楚，也支持结合sqlalchemy编写ORM，然后aiomysql提供了自己编写的异步引擎。
from aiomysql.sa import create_engine # 这个才是关键 下面我编写一个具体的例子来用异步语句操作下数据库，首先建立如下目录：
aio_mysql ├── demo.py ├── model.py └── requirements.txt 建立表：
create database test_mysql; CREATE TABLE user ( id INT AUTO_INCREMENT PRIMARY KEY, user_name VARCHAR(16) NOT NULL, pwd VARCHAR(32) NOT NULL, real_name VARCHAR(6) NOT NULL ); 一切准备就绪，下面编写代码：
# script: model.py import sqlalchemy as sa metadata = sa.MetaData() user = sa.Table( &#39;user&#39;, metadata, sa.Column(&#39;id&#39;, sa.Integer, autoincrement=True, primary_key=True), sa.">
<meta name="theme-color" content="#FFFFFF"><meta property="og:title" content="" />
<meta property="og:description" content="数据库使用 # 介绍中说的很明白，Sanic 是一个可以使用 async/await 语法编写项目的异步非阻塞框架，既然是异步框架，那么在使用过程中用到的第三方包也最好是异步的，比如http请求，最好就使用aihttp而非requests，对于数据库的连接，也是同样如此，下面我将用代码的形式来说明下如何在Sanic中连接数据库。
操作Mysql # 对于mysql数据库的异步操作，我只在一些脚本中用过，用的是aiomysql，其中官方文档中讲得很清楚，也支持结合sqlalchemy编写ORM，然后aiomysql提供了自己编写的异步引擎。
from aiomysql.sa import create_engine # 这个才是关键 下面我编写一个具体的例子来用异步语句操作下数据库，首先建立如下目录：
aio_mysql ├── demo.py ├── model.py └── requirements.txt 建立表：
create database test_mysql; CREATE TABLE user ( id INT AUTO_INCREMENT PRIMARY KEY, user_name VARCHAR(16) NOT NULL, pwd VARCHAR(32) NOT NULL, real_name VARCHAR(6) NOT NULL ); 一切准备就绪，下面编写代码：
# script: model.py import sqlalchemy as sa metadata = sa.MetaData() user = sa.Table( &#39;user&#39;, metadata, sa.Column(&#39;id&#39;, sa.Integer, autoincrement=True, primary_key=True), sa." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.howie6879.com/sanic_book/docs/01_skill/5.%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/" /><meta property="article:section" content="docs" />


<title>5.数据库使用 | Sanic-For-Pythoneer</title>
<link rel="manifest" href="/sanic_book/manifest.json">
<link rel="icon" href="/sanic_book/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/sanic_book/book.min.e935e20bd0d469378cb482f0958edf258c731a4f895dccd55799c6fbc8043f23.css" integrity="sha256-6TXiC9DUaTeMtILwlY7fJYxzGk&#43;JXczVV5nG&#43;8gEPyM=">
<script defer src="/sanic_book/en.search.min.af51d5596772464e8ed56a7194e27e848205a400b2523c4b4018f5772af80a04.js" integrity="sha256-r1HVWWdyRk6O1WpxlOJ&#43;hIIFpACyUjxLQBj1dyr4CgQ="></script>
<style>

  img[src$='#center']
  {
      display: block;
      margin: 0.7rem auto;  
       
  }
  
  img[src$='#floatleft']
  {
      float:left;
      margin: 0.7rem;       
       
  }
  
  img[src$='#floatright']
  {
      float:right;
      margin: 0.7rem;       
       
  }
  </style>
  
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  
</head>

<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a href="/sanic_book"><span>Sanic-For-Pythoneer</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>






  
<ul>
  
  <li>
    <a href="https://www.howie6879.cn/" target="_blank" rel="noopener">
        老胡的储物柜
      </a>
  </li>
  
  <li>
    <a href="https://cdn.jsdelivr.net/gh/howie6879/oss/uPic/wechat_howie.png" target="_blank" rel="noopener">
        微信公众号
      </a>
  </li>
  
  <li>
    <a href="https://github.com/howie6879" target="_blank" rel="noopener">
        Github
      </a>
  </li>
  
</ul>







  



  
  <ul>
    
      
        <li>
          
  
  

  
    <span>第一部分：技巧</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://www.howie6879.com/sanic_book/docs/01_skill/1.%E5%88%9D%E4%BD%BF%E7%94%A8/" class="">1.初使用</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://www.howie6879.com/sanic_book/docs/01_skill/2.%E9%85%8D%E7%BD%AE/" class="">2.配置</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://www.howie6879.com/sanic_book/docs/01_skill/3.%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84/" class="">3.项目结构</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://www.howie6879.com/sanic_book/docs/01_skill/4.%E5%B1%95%E7%A4%BA%E4%B8%80%E4%B8%AA%E9%A1%B5%E9%9D%A2/" class="">4.展示一个页面</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://www.howie6879.com/sanic_book/docs/01_skill/5.%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BD%BF%E7%94%A8/" class=" active">5.数据库使用</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://www.howie6879.com/sanic_book/docs/01_skill/6.%E5%B8%B8%E7%94%A8%E7%9A%84%E6%8A%80%E5%B7%A7/" class="">6.常用的技巧</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://www.howie6879.com/sanic_book/docs/01_skill/7.%E5%8F%AF%E9%9D%A0%E7%9A%84%E6%89%A9%E5%B1%95/" class="">7.可靠的扩展</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://www.howie6879.com/sanic_book/docs/01_skill/8.%E6%B5%8B%E8%AF%95%E4%B8%8E%E9%83%A8%E7%BD%B2/" class="">8.测试与部署</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <span>第二部分：附录</span>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="https://www.howie6879.com/sanic_book/docs/02_appendix/Sanic%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E5%9F%BA%E4%BA%8E0.1.2/" class="">Sanic源码阅读：基于0.1.2</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="https://www.howie6879.com/sanic_book/docs/02_appendix/%E5%85%B3%E4%BA%8E%E8%A3%85%E9%A5%B0%E5%99%A8/" class="">关于装饰器</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var e=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/sanic_book/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>5.数据库使用</strong>

  <label for="toc-control">
    
    <img src="/sanic_book/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#数据库使用">数据库使用</a>
      <ul>
        <li><a href="#操作mysql">操作Mysql</a></li>
        <li><a href="#操作mongodb">操作MongoDB</a></li>
        <li><a href="#操作redis">操作Redis</a></li>
        <li><a href="#说明">说明</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h2 id="数据库使用">
  数据库使用
  <a class="anchor" href="#%e6%95%b0%e6%8d%ae%e5%ba%93%e4%bd%bf%e7%94%a8">#</a>
</h2>
<p>介绍中说的很明白，<code>Sanic</code> 是一个可以使用 <code>async/await</code> 语法编写项目的<strong>异步</strong>非阻塞框架，既然是异步框架，那么在使用过程中用到的第三方包也最好是异步的，比如http请求，最好就使用<code>aihttp</code>而非<code>requests</code>，对于数据库的连接，也是同样如此，下面我将用代码的形式来说明下如何在Sanic中连接数据库。</p>
<h3 id="操作mysql">
  操作Mysql
  <a class="anchor" href="#%e6%93%8d%e4%bd%9cmysql">#</a>
</h3>
<p>对于mysql数据库的异步操作，我只在一些脚本中用过，用的是<a href="https://github.com/aio-libs/aiomysql">aiomysql</a>，其中官方文档中讲得很清楚，也支持结合<code>sqlalchemy</code>编写<code>ORM</code>，然后aiomysql提供了自己编写的异步引擎。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> aiomysql.sa <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这个才是关键</span>
</span></span></code></pre></div><p>下面我编写一个具体的例子来用异步语句操作下数据库，首先建立如下目录：</p>
<pre tabindex="0"><code class="language-shel" data-lang="shel">aio_mysql
├── demo.py
├── model.py
└── requirements.txt
</code></pre><p>建立表：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-mysql" data-lang="mysql"><span style="display:flex;"><span><span style="color:#66d9ef">create</span> <span style="color:#66d9ef">database</span> test_mysql;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">user</span>
</span></span><span style="display:flex;"><span>(
</span></span><span style="display:flex;"><span>  id        <span style="color:#66d9ef">INT</span> <span style="color:#66d9ef">AUTO_INCREMENT</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>,
</span></span><span style="display:flex;"><span>  user_name <span style="color:#66d9ef">VARCHAR</span>(<span style="color:#ae81ff">16</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>  pwd       <span style="color:#66d9ef">VARCHAR</span>(<span style="color:#ae81ff">32</span>) <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>,
</span></span><span style="display:flex;"><span>  real_name <span style="color:#66d9ef">VARCHAR</span>(<span style="color:#ae81ff">6</span>)  <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span>
</span></span><span style="display:flex;"><span>);
</span></span></code></pre></div><p>一切准备就绪，下面编写代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># script: model.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> sqlalchemy <span style="color:#66d9ef">as</span> sa
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>metadata <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>MetaData()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>user <span style="color:#f92672">=</span> sa<span style="color:#f92672">.</span>Table(
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;user&#39;</span>,
</span></span><span style="display:flex;"><span>    metadata,
</span></span><span style="display:flex;"><span>    sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;id&#39;</span>, sa<span style="color:#f92672">.</span>Integer, autoincrement<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, primary_key<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>),
</span></span><span style="display:flex;"><span>    sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;user_name&#39;</span>, sa<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">16</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>    sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;pwd&#39;</span>, sa<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">32</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>    sa<span style="color:#f92672">.</span>Column(<span style="color:#e6db74">&#39;real_name&#39;</span>, sa<span style="color:#f92672">.</span>String(<span style="color:#ae81ff">6</span>), nullable<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># script: demo.py</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> aiomysql.sa <span style="color:#f92672">import</span> create_engine
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> model <span style="color:#f92672">import</span> user,metadata
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">go</span>(loop):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    aiomysql项目地址：https://github.com/aio-libs/aiomysql
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param loop:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :return:
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    engine <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> create_engine(user<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;root&#39;</span>, db<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test_mysql&#39;</span>,
</span></span><span style="display:flex;"><span>                                 host<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;127.0.0.1&#39;</span>, password<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;123456&#39;</span>, loop<span style="color:#f92672">=</span>loop)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">with</span> engine<span style="color:#f92672">.</span>acquire() <span style="color:#66d9ef">as</span> conn:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> conn<span style="color:#f92672">.</span>execute(user<span style="color:#f92672">.</span>insert()<span style="color:#f92672">.</span>values(user_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;user_name01&#39;</span>, pwd<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;123456&#39;</span>, real_name<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;real_name01&#39;</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">await</span> conn<span style="color:#f92672">.</span>execute(<span style="color:#e6db74">&#39;commit&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">for</span> row <span style="color:#f92672">in</span> conn<span style="color:#f92672">.</span>execute(user<span style="color:#f92672">.</span>select()):
</span></span><span style="display:flex;"><span>            print(row<span style="color:#f92672">.</span>user_name, row<span style="color:#f92672">.</span>pwd)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    engine<span style="color:#f92672">.</span>close()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">await</span> engine<span style="color:#f92672">.</span>wait_closed()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>loop <span style="color:#f92672">=</span> asyncio<span style="color:#f92672">.</span>get_event_loop()
</span></span><span style="display:flex;"><span>loop<span style="color:#f92672">.</span>run_until_complete(go(loop))
</span></span></code></pre></div><p>运行 python demo.py，会看到如下输出：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>user_name01 <span style="color:#ae81ff">123456</span>
</span></span></code></pre></div><p>很简单吧，具体示例见<a href="https://github.com/howie6879/Sanic-For-Pythoneer/tree/master/examples/demo05/aio_mysql">aio_mysql</a>，如果你比较喜欢类似SQLAlchemy的操作方式，这里推荐一个异步ORM，<a href="https://github.com/fantix/gino">gino</a>。</p>
<h3 id="操作mongodb">
  操作MongoDB
  <a class="anchor" href="#%e6%93%8d%e4%bd%9cmongodb">#</a>
</h3>
<p>我业余写的一个项目，基本用的就是<code>MongoDB</code>来储存数据，对于异步操作<code>MongoDB</code>，目前Python主要用的是<a href="https://motor.readthedocs.io/en/stable/index.html">motor</a>，使用起来依旧很简单，但是结合具体功能，就有不同的需求，最后就会形成各种各样的连接方案，这里我主要分享下自己是如何使用的，目录如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>aio_mongo
</span></span><span style="display:flex;"><span>├── demo.py
</span></span><span style="display:flex;"><span>└── requirements.txt
</span></span></code></pre></div><p><code>MongoDB</code>是一个基于分布式文件存储的数据库，它介于关系数据库和非关系数据库之间，所以它使用起来也是比较灵活的，打开<code>demo.py</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> wraps
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> motor.motor_asyncio <span style="color:#f92672">import</span> AsyncIOMotorClient
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>MONGODB <span style="color:#f92672">=</span> dict(
</span></span><span style="display:flex;"><span>    MONGO_HOST<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;MONGO_HOST&#39;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>    MONGO_PORT<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;MONGO_PORT&#39;</span>, <span style="color:#ae81ff">27017</span>),
</span></span><span style="display:flex;"><span>    MONGO_USERNAME<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;MONGO_USERNAME&#39;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>    MONGO_PASSWORD<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;MONGO_PASSWORD&#39;</span>, <span style="color:#e6db74">&#34;&#34;</span>),
</span></span><span style="display:flex;"><span>    DATABASE<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;test_mongodb&#39;</span>,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MotorBaseOld</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    默认实现了一个db只创建一次，缺点是更换集合麻烦
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    _db <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>    MONGODB <span style="color:#f92672">=</span> MONGODB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">client</span>(self, db):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># motor</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>motor_uri <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mongodb://</span><span style="color:#e6db74">{account}{host}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{port}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{database}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(
</span></span><span style="display:flex;"><span>            account<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{username}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{password}</span><span style="color:#e6db74">@&#39;</span><span style="color:#f92672">.</span>format(
</span></span><span style="display:flex;"><span>                username<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_USERNAME&#39;</span>],
</span></span><span style="display:flex;"><span>                password<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_PASSWORD&#39;</span>]) <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_USERNAME&#39;</span>] <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>            host<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_HOST&#39;</span>] <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_HOST&#39;</span>] <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;localhost&#39;</span>,
</span></span><span style="display:flex;"><span>            port<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_PORT&#39;</span>] <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_PORT&#39;</span>] <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">27017</span>,
</span></span><span style="display:flex;"><span>            database<span style="color:#f92672">=</span>db)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> AsyncIOMotorClient(self<span style="color:#f92672">.</span>motor_uri)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">db</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>_db <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_db <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>client(self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;DATABASE&#39;</span>])[self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;DATABASE&#39;</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_db
</span></span></code></pre></div><p>我最开始，使用的是这种方式来连接<code>MongoDB</code>，上面代码保证了集合中的db被_db维护，保证只会创建一次，如果你项目中不会随意更改集合的话，也没什么大问题，如果不是，我推荐使用下面这样的连接方式，可以自由地更换集合与db：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">singleton</span>(cls):
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    用装饰器实现的实例 不明白装饰器可见附录 装饰器：https://github.com/howie6879/Sanic-For-Pythoneer/blob/master/docs/part2/</span><span style="color:#e6db74">%E</span><span style="color:#e6db74">9</span><span style="color:#e6db74">%99%</span><span style="color:#e6db74">84</span><span style="color:#e6db74">%E</span><span style="color:#e6db74">5%BD</span><span style="color:#e6db74">%95%</span><span style="color:#e6db74">EF%BC%9A</span><span style="color:#e6db74">%E</span><span style="color:#e6db74">5</span><span style="color:#e6db74">%85%</span><span style="color:#e6db74">B3</span><span style="color:#e6db74">%E</span><span style="color:#e6db74">4%BA</span><span style="color:#e6db74">%8E%E</span><span style="color:#e6db74">8%A3</span><span style="color:#e6db74">%85%</span><span style="color:#e6db74">E9%A5%B0</span><span style="color:#e6db74">%E</span><span style="color:#e6db74">5</span><span style="color:#e6db74">%99%</span><span style="color:#e6db74">A8.md
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :param cls: cls
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    :return: instance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    _instances <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@wraps</span>(cls)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">instance</span>(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kw):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> cls <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> _instances:
</span></span><span style="display:flex;"><span>            _instances[cls] <span style="color:#f92672">=</span> cls(<span style="color:#f92672">*</span>args, <span style="color:#f92672">**</span>kw)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> _instances[cls]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> instance
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@singleton</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MotorBase</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    更改mongodb连接方式 单例模式下支持多库操作
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    About motor&#39;s doc: https://github.com/mongodb/motor
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    _db <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    _collection <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>    MONGODB <span style="color:#f92672">=</span> MONGODB
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>motor_uri <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">client</span>(self, db):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># motor</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>motor_uri <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mongodb://</span><span style="color:#e6db74">{account}{host}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{port}</span><span style="color:#e6db74">/</span><span style="color:#e6db74">{database}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(
</span></span><span style="display:flex;"><span>            account<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{username}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">{password}</span><span style="color:#e6db74">@&#39;</span><span style="color:#f92672">.</span>format(
</span></span><span style="display:flex;"><span>                username<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_USERNAME&#39;</span>],
</span></span><span style="display:flex;"><span>                password<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_PASSWORD&#39;</span>]) <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_USERNAME&#39;</span>] <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;&#39;</span>,
</span></span><span style="display:flex;"><span>            host<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_HOST&#39;</span>] <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_HOST&#39;</span>] <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;localhost&#39;</span>,
</span></span><span style="display:flex;"><span>            port<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_PORT&#39;</span>] <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>MONGODB[<span style="color:#e6db74">&#39;MONGO_PORT&#39;</span>] <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">27017</span>,
</span></span><span style="display:flex;"><span>            database<span style="color:#f92672">=</span>db)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> AsyncIOMotorClient(self<span style="color:#f92672">.</span>motor_uri)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_db</span>(self, db<span style="color:#f92672">=</span>MONGODB[<span style="color:#e6db74">&#39;DATABASE&#39;</span>]):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        获取一个db实例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param db: database name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return: the motor db instance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> db <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_db:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_db[db] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>client(db)[db]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_db[db]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_collection</span>(self, db_name, collection):
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        获取一个集合实例
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param db_name: database name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :param collection: collection name
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        :return: the motor collection instance
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>        collection_key <span style="color:#f92672">=</span> db_name <span style="color:#f92672">+</span> collection
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> collection_key <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>_collection:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_collection[collection_key] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>get_db(db_name)[collection]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_collection[collection_key]
</span></span></code></pre></div><p>为了避免重复创建MotorBase实例，可以实现一个单例模式来保证资源的有效利用，具体代码以及运行demo见<a href="https://github.com/howie6879/Sanic-For-Pythoneer/tree/master/examples/demo05/aio_mongo">aio_mongo</a></p>
<h3 id="操作redis">
  操作Redis
  <a class="anchor" href="#%e6%93%8d%e4%bd%9credis">#</a>
</h3>
<p>对于Redis的异步操作，我选用的是<code>asyncio_redis</code>，你大可不必非要使用这个，或许其他的库实现地更好，我只是用这个举个例子，建立如下目录：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>aio_redis
</span></span><span style="display:flex;"><span>├── demo.py
</span></span><span style="display:flex;"><span>└── requirements.txt
</span></span></code></pre></div><p>建立一个redis连接池：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> os
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> asyncio_redis
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>REDIS_DICT <span style="color:#f92672">=</span> dict(
</span></span><span style="display:flex;"><span>    IS_CACHE<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>    REDIS_ENDPOINT<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;REDIS_ENDPOINT&#39;</span>, <span style="color:#e6db74">&#34;localhost&#34;</span>),
</span></span><span style="display:flex;"><span>    REDIS_PORT<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;REDIS_PORT&#39;</span>, <span style="color:#ae81ff">6379</span>),
</span></span><span style="display:flex;"><span>    REDIS_PASSWORD<span style="color:#f92672">=</span>os<span style="color:#f92672">.</span>getenv(<span style="color:#e6db74">&#39;REDIS_PASSWORD&#39;</span>, <span style="color:#66d9ef">None</span>),
</span></span><span style="display:flex;"><span>    DB<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    POOLSIZE<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>,
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisSession</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    建立redis连接池
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    _pool <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">async</span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_redis_pool</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> self<span style="color:#f92672">.</span>_pool:
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>_pool <span style="color:#f92672">=</span> <span style="color:#66d9ef">await</span> asyncio_redis<span style="color:#f92672">.</span>Pool<span style="color:#f92672">.</span>create(
</span></span><span style="display:flex;"><span>                host<span style="color:#f92672">=</span>str(REDIS_DICT<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;REDIS_ENDPOINT&#39;</span>, <span style="color:#e6db74">&#34;localhost&#34;</span>)), port<span style="color:#f92672">=</span>int(REDIS_DICT<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;REDIS_PORT&#39;</span>, <span style="color:#ae81ff">6379</span>)),
</span></span><span style="display:flex;"><span>                poolsize<span style="color:#f92672">=</span>int(REDIS_DICT<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;POOLSIZE&#39;</span>, <span style="color:#ae81ff">10</span>)), password<span style="color:#f92672">=</span>REDIS_DICT<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;REDIS_PASSWORD&#39;</span>, <span style="color:#66d9ef">None</span>),
</span></span><span style="display:flex;"><span>                db<span style="color:#f92672">=</span>REDIS_DICT<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;DB&#39;</span>, <span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>_pool
</span></span></code></pre></div><p>具体见<a href="https://github.com/howie6879/Sanic-For-Pythoneer/blob/master/examples/demo05/aio_redis/demo.py">aio_redis</a>，使用起来很简单，不做多叙述。</p>
<h3 id="说明">
  说明
  <a class="anchor" href="#%e8%af%b4%e6%98%8e">#</a>
</h3>
<p>如果你使用其它类型的数据库，其实使用方式也是类似。
本章代码地址，见<a href="https://github.com/howie6879/Sanic-For-Pythoneer/tree/master/examples/demo05">demo05</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/howie6879/oss/uPic/qrcode_for_gh_3f02ace79dfb_258.jpg#center" alt="老胡的储物柜" /></p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>

 
        
<div class="guide-links">
    
    
    </div>
      </footer>

      
  
  <div class="book-comments">

<footer>
    <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://www.howie6879.cn/css/gitalk.css?v=0.0.0">
    <script src="https://www.howie6879.cn/js/gitalk.min.js?v=0.0.0"></script>
    <script>
        var gitalk = new Gitalk({
            clientID: '2c38ed8e7f85da0f1510',
            clientSecret: '1984f14456cb1a999dde013ec6a3e6123a92d59a',
            repo: 'howie6879.github.io',
            owner: 'howie6879',
            admin: ['howie6879'],
            id: location.pathname.substr(0, 48), 
            distractionFreeMode: false 
        })

        gitalk.render('gitalk-container')
    </script>
</footer></div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#数据库使用">数据库使用</a>
      <ul>
        <li><a href="#操作mysql">操作Mysql</a></li>
        <li><a href="#操作mongodb">操作MongoDB</a></li>
        <li><a href="#操作redis">操作Redis</a></li>
        <li><a href="#说明">说明</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>

</html>












